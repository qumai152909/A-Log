# 缓存机制

浏览器的缓存机制也就是我们说的HTTP缓存机制；

其机制是根据**HTTP报文的缓存标识**进行的；



# 概念和术语

- **缓存命中率**：从缓存中得到请求数与所有请求数的比率。理想状态是越高越好。
- **过期内容**：超过设置的有效时间，被标记为 '陈旧' 的内容。通常过期内容不能用于回复客户端的请求，必须重新向源服务器请求新的内容或者验证缓存的内容是否仍然可用。
- **验证**：验证缓存中的过期内容是否仍然有效，验证通过的话刷新过期时间或策略。
- **失效**：失效就是把内容从缓存中移除。当内容发生改变时就必须移除失效的内容。

***

1. expires: 告知客户端资源缓存失效的绝对时间
2. last-modified: 资源最后一次修改的时间
3. Etag: 文件的特殊标识
4. cache-control:告诉客户端或是服务器如何处理缓存。
5. private: cache-control里的响应指令.表示客户端可以缓存
6. public: cache-control里的响应指令.表示客户端和代理服务器都可缓存.如果没有明确指定private，则默认为public。
7. no-cache: cache-control里的指令.表示需要可以缓存，但每次用应该去向服务器验证缓存是否可用
8. no-store: cache-control字段里的指令.表示所有内容都不会缓存，强制缓存，对比缓存都不会触发.
9. max-age=xxx: cache-control字段里的指令.表示缓存的内容将在 xxx 秒后失效

# 缓存的作用

通过复用以前获取的资源：

- 减少网络带宽消耗
- 降低服务器压力
- 减少网络延迟，加快页面打开速度

# 限制

然而常见的 HTTP 缓存只能存储 [`GET`](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/GET) 响应，对于其他类型的响应则无能为力。（一般只有GET请求才会被缓存）

​	

# 强制缓存

强制缓存(自己强制决定)：

就是向浏览器缓存查找该请求的缓存结果, 

+ 若不存在该缓存结果和缓存标识，强制缓存失效，则直接向服务器发起请求（跟第一次发起请求一致）
+ 有缓存结果和缓存标识,   但是结果已经失效,   强制缓存失效,   则使用协商缓存
+ **缓存中存在缓存结果和缓存标识,   且该结果仍然有效,  强制缓存生效, 直接返回该缓存结果**

## 缓存字段

第一次，浏览器在向服务器发送http请求后，服务器不仅返回结果，还返回相应的缓存字段；

其中涉及强制缓存的字段分别是**Expires**和**Cache-Control**，其中**Cache-Control优先级比Expires高。**



## 强缓存在浏览器上的表现

- Firefox浏览器对强缓存表现为一个灰色的200状态码。
- Chrome浏览器状态码表现为:`200 (from disk cache)或是200 OK (from memory cache)`

说明: Chrome会根据本地内存的使用率来决定缓存存放在哪，**如果内存使用率很高，放在磁盘里面；如果磁盘的使用率很高，会暂时放在内存里面**。这就可以比较合理的解释了为什么同一个资源有时是from memory cache有时是from disk cache的问题了。

## 为什么会有协商缓存？

但是强制缓存存在一个问题，该缓存方式优先级高，如果在过期时间内缓存的资源在服务器上更新了，客服端不能及时获取最新的资源。这时怎么办? 于是就有了协商缓存.

# 协商缓存

<img src="/Users/yingyingsun/Github/A-Log/imgs/协商缓存.png" alt="协商缓存" style="zoom:40%;" />

1， 浏览器向缓存发起请求后，若缓存中存在缓存结果（资源）和缓存标识，但缓存结果已经失效了，

2，此时，浏览器会携带该缓存标识，向服务器发送请求，来验证失效的缓存结果是否仍然可用（是否有修改）

3， **若验证通过**（即失效的的资源仍然可用），则服务器会发送一条响应告知浏览器缓存可用，响应码为304，响应报文中不包含主体数据（即响应中不返回结果）。  ----->>>     浏览收到响应后，会直接从缓存中获取缓存结果。

​	响应报文中，含有新的过期时间，浏览器会根据这个时间刷新本地缓存中的缓存标识？？？？？？

4，**若验证不通过，如下图**：服务器发送响应返回新的资源，响应码是200， 响应报文中有主体数据，

<img src="/Users/yingyingsun/Github/A-Log/imgs/协商缓存2.png" alt="协商缓存2" style="zoom:50%;" />







# 综述

+ 强制缓存优先于协商缓存进行，

+ 若强制缓存(Expires和Cache-Control)生效则直接使用缓存，若不生效则进行协商缓存(Last-Modified / If-Modified-Since和Etag / If-None-Match)，
+ 协商缓存由服务器决定是否使用缓存（由服务器验证），
  + 若协商缓存*失效*，那么代表该请求的缓存失效，重新获取请求结果（200），再存入浏览器缓存中；
  + 协商缓存*生效*则返回304，继续使用缓存，主要过程如下：



<img src="/Users/yingyingsun/Github/A-Log/imgs/缓存-总.png" alt="缓存-总" style="zoom:50%;" />



# 链接

https://blog.csdn.net/qq_41800649/article/details/108941774

https://juejin.cn/post/6844903781084184584

https://juejin.cn/post/6844903981395755015

https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Caching#%E7%BC%93%E5%AD%98%E6%8E%A7%E5%88%B6

# 其他问题

**1， 浏览器每次发起请求，都会先在浏览器缓存中查找该请求的结果以及缓存标识？**





















